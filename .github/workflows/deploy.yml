name: CI/CD Pipeline - Ecommerce Platform

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DOTNET_VERSION: "9.0"
  REGISTRY_URL: ${{ secrets.REGISTRY_URL || 'docker.io' }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  IMAGE_GATEWAY: ecomgatewayapi
  IMAGE_CORE: ecomcoreapi
  IMAGE_USERS: ecomusersapi
  HEALTH_CHECK_TIMEOUT: 300s

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      should-deploy: ${{ steps.changes.outputs.should-deploy }}

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Check for changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - will deploy"
          elif [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "Main/Develop branch - will deploy"
          else
            if git diff --name-only HEAD~1 HEAD | grep -E "\\.(cs|csproj|sln|Dockerfile|yml|yaml|json)$"; then
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "Source code changes detected - will deploy"
            else
              echo "should-deploy=false" >> $GITHUB_OUTPUT
              echo "No significant changes - skipping deployment"
            fi
          fi

      - name: 🔧 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 📦 Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props', '**/*.targets') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: 📦 Restore dependencies
        run: |
          dotnet restore Moclaw.Ecommerce.sln --verbosity minimal

      - name: 🏗️ Build solution
        run: |
          dotnet build Moclaw.Ecommerce.sln --configuration Release --no-restore --verbosity minimal

      - name: 🧪 Run tests
        run: |
          echo "🔍 Searching for test projects..."
          if find . -name "*Test*.csproj" -o -name "*Tests.csproj" | head -1 | grep -q .; then
            echo "✅ Test projects found, running tests..."
            dotnet test Moclaw.Ecommerce.sln --configuration Release --no-build --verbosity minimal --logger trx --results-directory ./TestResults
          else
            echo "⚠️ No test projects found, skipping tests"
          fi

      - name: 🏷️ Generate metadata
        id: meta
        run: |
          TAG="${{ github.sha }}"
          SHORT_SHA="${TAG:0:8}"
          echo "tags=${SHORT_SHA}" >> $GITHUB_OUTPUT

  build-images:
    name: Build Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: needs.build-and-test.outputs.should-deploy == 'true'
    strategy:
      matrix:
        service:
          - name: gateway-api
            dockerfile: Ecom.Gateway/src/Ecom.Gateway.API/Dockerfile
            image_name: ecomgatewayapi
          - name: core-api
            dockerfile: Ecom.Core/src/Ecom.Core.API/Dockerfile
            image_name: ecomcoreapi
          - name: users-api
            dockerfile: Ecom.Users/src/Ecom.Users.API/Dockerfile
            image_name: ecomusersapi
      fail-fast: false
      max-parallel: 3

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔐 Login to Docker registry
        if: env.REGISTRY_USERNAME != '' && env.REGISTRY_PASSWORD != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: ℹ️ Registry info
        run: |
          if [ -n "${{ env.REGISTRY_USERNAME }}" ] && [ -n "${{ env.REGISTRY_PASSWORD }}" ]; then
            echo "✅ Registry credentials available - will push images"
            echo "Registry: ${{ env.REGISTRY_URL }}"
            echo "Username: ${{ env.REGISTRY_USERNAME }}"
            echo "Image will be tagged as: ${{ env.REGISTRY_USERNAME }}/${{ matrix.service.image_name }}:${{ needs.build-and-test.outputs.image-tag }}"
          else
            echo "⚠️ No registry credentials - will only build locally"
          fi

      - name: 🏗️ Build and push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: ${{ env.REGISTRY_USERNAME != '' && env.REGISTRY_PASSWORD != '' }}
          tags: |
            ${{ env.REGISTRY_USERNAME }}/${{ matrix.service.image_name }}:${{ needs.build-and-test.outputs.image-tag }}
            ${{ env.REGISTRY_USERNAME }}/${{ matrix.service.image_name }}:latest
          platforms: linux/amd64
          cache-from: type=registry,ref=${{ env.REGISTRY_USERNAME }}/${{ matrix.service.image_name }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_USERNAME }}/${{ matrix.service.image_name }}:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  deploy-local:
    name: Deploy to Local Environment
    runs-on: ubuntu-latest
    needs: [build-and-test, build-images]
    if: needs.build-and-test.outputs.should-deploy == 'true'

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Login to Docker registry
        if: env.REGISTRY_USERNAME != '' && env.REGISTRY_PASSWORD != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: 🧹 Clean up existing containers
        run: |
          echo "🧹 Cleaning up existing containers..."
          docker compose down --remove-orphans || true
          docker container prune -f || true
          docker network prune -f || true

      - name: 📥 Pull Docker images
        if: env.REGISTRY_USERNAME != '' && env.REGISTRY_PASSWORD != ''
        run: |
          echo "📥 Pulling latest images from registry..."
          IMAGE_TAG="${{ needs.build-and-test.outputs.image-tag }}"
          
          # Pull images if they exist in registry
          docker pull ${{ env.REGISTRY_USERNAME }}/ecomgatewayapi:${IMAGE_TAG} || echo "⚠️ Gateway image not found in registry"
          docker pull ${{ env.REGISTRY_USERNAME }}/ecomcoreapi:${IMAGE_TAG} || echo "⚠️ Core image not found in registry"
          docker pull ${{ env.REGISTRY_USERNAME }}/ecomusersapi:${IMAGE_TAG} || echo "⚠️ Users image not found in registry"
          
          # Also pull latest tags
          docker pull ${{ env.REGISTRY_USERNAME }}/ecomgatewayapi:latest || echo "⚠️ Gateway latest image not found"
          docker pull ${{ env.REGISTRY_USERNAME }}/ecomcoreapi:latest || echo "⚠️ Core latest image not found"
          docker pull ${{ env.REGISTRY_USERNAME }}/ecomusersapi:latest || echo "⚠️ Users latest image not found"

      - name: � Setup monitoring configuration
        run: |
          mkdir -p monitoring
          if [ ! -f "monitoring/prometheus.yml" ]; then
            cat > monitoring/prometheus.yml << 'EOF'
          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
            
            - job_name: 'ecom-gateway'
              static_configs:
                - targets: ['ecom.gateway.api:8080']
              metrics_path: '/metrics'
              
            - job_name: 'ecom-core'
              static_configs:
                - targets: ['ecom.core.api:8080']
              metrics_path: '/metrics'
              
            - job_name: 'ecom-users'
              static_configs:
                - targets: ['ecom.users.api:8080']
              metrics_path: '/metrics'
          EOF
          fi

      - name: 🚀 Deploy with Docker Compose
        env:
          IMAGE_TAG: ${{ needs.build-and-test.outputs.image-tag }}
          DOCKER_REGISTRY: ${{ env.REGISTRY_USERNAME && format('{0}/', env.REGISTRY_USERNAME) || '' }}
        run: |
          echo "🚀 Starting Docker deployment..."
          echo "Image Tag: $IMAGE_TAG"
          echo "Registry: $DOCKER_REGISTRY"
          echo "Registry Username: ${{ env.REGISTRY_USERNAME }}"

          # Set environment variables for docker-compose
          export DOCKER_REGISTRY="${DOCKER_REGISTRY}"
          export IMAGE_TAG="${IMAGE_TAG}"

          # Create override file with specific image tags if registry is available
          if [ -n "${{ env.REGISTRY_USERNAME }}" ] && [ -n "$IMAGE_TAG" ]; then
            echo "✅ Using registry images with tag: $IMAGE_TAG"
            cat > docker-compose.override.yml << EOF
          version: '3.8'
          services:
            ecom.gateway.api:
              image: ${{ env.REGISTRY_USERNAME }}/ecomgatewayapi:${IMAGE_TAG}
              build: null
            ecom.core.api:
              image: ${{ env.REGISTRY_USERNAME }}/ecomcoreapi:${IMAGE_TAG}
              build: null
            ecom.users.api:
              image: ${{ env.REGISTRY_USERNAME }}/ecomusersapi:${IMAGE_TAG}
              build: null
          EOF
            echo "📋 Override file created:"
            cat docker-compose.override.yml
          else
            echo "⚠️ No registry credentials - will build locally"
          fi

          # Start services
          if [ -f "docker-compose.override.yml" ]; then
            echo "🚀 Deploying with registry images..."
            docker compose -f docker-compose.yml -f docker-compose.override.yml up -d
          else
            echo "🏗️ Building and deploying locally..."
            docker compose up -d --build
          fi

          echo "✅ Docker deployment initiated"

      - name: ⏳ Wait for services to be ready
        run: |
          echo "⏳ Waiting for Docker services to start..."
          sleep 15

          # Enhanced health check function
          check_service() {
            local port=$1
            local name=$2
            local max_attempts=15
            local attempt=1
            
            echo "🔍 Checking $name service on port $port..."
            
            while [ $attempt -le $max_attempts ]; do
              # Check if container is running first
              if ! docker compose ps --services --filter "status=running" | grep -q "${name,,}"; then
                echo "⚠️ $name container is not running (attempt $attempt/$max_attempts)"
                sleep 10
                attempt=$((attempt + 1))
                continue
              fi
              
              # Check HTTP endpoints
              if curl -s -f "http://localhost:$port/health" > /dev/null 2>&1; then
                echo "✅ $name health endpoint is responding on port $port"
                return 0
              elif curl -s -f "http://localhost:$port" > /dev/null 2>&1; then
                echo "✅ $name is responding on port $port (no health endpoint)"
                return 0
              fi
              
              echo "⏳ Waiting for $name on port $port (attempt $attempt/$max_attempts)..."
              sleep 10
              attempt=$((attempt + 1))
            done
            
            echo "❌ $name health check timeout on port $port"
            echo "📋 Container logs for debugging:"
            docker compose logs --tail=20 || true
            return 1
          }

          # Check each service with Docker-aware health checks
          check_service 5300 "Gateway-API" &
          check_service 5301 "Core-API" &
          check_service 5302 "Users-API" &
          
          # Wait for all health checks
          wait
          
          echo "✅ All services health checks completed"

      - name: 📊 Show deployment status
        run: |
          echo "🎉 Deployment completed!"
          echo "===================="
          echo "Services:"
          docker compose ps
          echo ""
          echo "Service URLs:"
          echo "- Gateway API: http://localhost:5300"
          echo "- Core API: http://localhost:5301"
          echo "- Users API: http://localhost:5302"
          echo "- Prometheus: http://localhost:9090"
          echo "- Grafana: http://localhost:3000"

      - name: 🧹 Cleanup on failure
        if: failure()
        run: |
          echo "❌ Deployment failed, cleaning up..."
          docker-compose logs --tail=50
          docker-compose down --remove-orphans || true
          docker container prune -f || true

  post-deploy-cleanup:
    name: Post-deployment Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-local]
    if: always()

    steps:
      - name: 🧹 Post-deployment cleanup
        run: |
          echo "🧹 Starting post-deployment cleanup..."

          # Clean up old Docker images (keep last 3 versions)
          echo "🖼️ Cleaning up old images..."
          docker image prune -f --filter "until=24h" || true
          docker builder prune -f --filter "until=24h" || true

          # Clean up unused networks (keep active ones)
          echo "🌐 Cleaning up unused networks..."
          docker network prune -f || true

          # Clean up temporary files
          echo "📁 Cleaning up temporary files..."
          rm -f docker-compose.override.yml || true

          # Show final system status
          echo "📊 Final system status:"
          echo "Docker system usage:"
          docker system df || true
          echo ""
          echo "Active containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true

          echo "✅ Post-deployment cleanup completed"

  notify-status:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-local, post-deploy-cleanup]
    if: always()

    steps:
      - name: 📢 Deployment Status Summary
        run: |
          echo "🚀 Deployment Pipeline Summary"
          echo "=============================="
          echo "Build & Test: ${{ needs.build-and-test.result }}"
          echo "Deploy: ${{ needs.deploy-local.result }}"
          echo "Cleanup: ${{ needs.post-deploy-cleanup.result }}"
          echo "Image Tag: ${{ needs.build-and-test.outputs.image-tag }}"
          echo ""

          if [ "${{ needs.deploy-local.result }}" = "success" ]; then
            echo "✅ Deployment completed successfully!"
            echo "🌐 Services are available at:"
            echo "  - Gateway API: http://localhost:5300"
            echo "  - Core API: http://localhost:5301"
            echo "  - Users API: http://localhost:5302"
            echo "  - Prometheus: http://localhost:9090"
            echo "  - Grafana: http://localhost:3000"
          else
            echo "❌ Deployment failed!"
            echo "🧹 Resources have been cleaned up automatically"
            echo "🔍 Check the deployment logs for details"
          fi
