name: CI/CD for Docker Compose and Minikube

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Pre-clean workspace
        run: |
          echo "ðŸ§¹ Cleaning workspace..."
          docker stop $(docker ps -aq) 2>/dev/null || true
          docker rm $(docker ps -aq) 2>/dev/null || true
          docker system prune -f || true
          sudo rm -rf ./monitoring 2>/dev/null || true
          for port in 5301 5302 9090 3000; do
            sudo lsof -ti:$port | xargs -r sudo kill -9 || true
          done

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        run: |
          if ! command -v dotnet &> /dev/null; then
            echo "Installing .NET..."
            mkdir -p "$HOME/.dotnet"
            curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --channel 9.0 --install-dir "$HOME/.dotnet"
            echo "DOTNET_ROOT=$HOME/.dotnet" >> "$GITHUB_ENV"
            echo "$HOME/.dotnet" >> "$GITHUB_PATH"
          fi
          dotnet --version

      - name: Create monitoring configuration
        run: |
          echo "âš™ï¸ Creating monitoring config..."
          mkdir -p monitoring/dashboards
          
          cat > monitoring/prometheus.yml << 'EOF'
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'ecom-core-api'
              static_configs:
                - targets: ['ecom.core.api:8080']
              metrics_path: '/metrics'
            - job_name: 'ecom-users-api'
              static_configs:
                - targets: ['ecom.users.api:8080']
              metrics_path: '/metrics'
          EOF
          
          cat > monitoring/dashboards/ecommerce-api.json << 'EOF'
          {
            "dashboard": {
              "title": "Ecommerce API Metrics",
              "panels": [
                {
                  "title": "HTTP Requests Rate",
                  "type": "graph",
                  "targets": [{"expr": "rate(http_requests_total[5m])"}],
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
                }
              ],
              "time": {"from": "now-1h", "to": "now"}
            }
          }
          EOF

      - name: Build Docker images
        run: |
          echo "ðŸ³ Building images..."
          docker build -f Ecom.Core/src/Ecom.Core.API/Dockerfile -t moclaw/ecom-core-api:latest .
          docker build -f Ecom.Users/src/Ecom.Users.API/Dockerfile -t moclaw/ecom-users-api:latest .

      - name: Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          kubernetes-version: 'v1.25.13'
          memory: '4096'
          cpus: '2'

      - name: Start Minikube
        run: |
          echo "ðŸš€ Starting Minikube..."
          minikube start --driver=docker --kubernetes-version=v1.25.13 --memory=4096 --cpus=2
          kubectl get nodes

      - name: Load images to Minikube
        run: |
          echo "ðŸ”„ Loading images..."
          minikube image load moclaw/ecom-core-api:latest
          minikube image load moclaw/ecom-users-api:latest

      - name: Deploy to Minikube
        run: |
          echo "ðŸš€ Deploying to Kubernetes..."
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/core-deployment.yaml
          kubectl apply -f k8s/users-deployment.yaml
          
          # Create monitoring namespace
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          
          # Deploy Prometheus
          kubectl apply -f - << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: monitoring
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                containers:
                - name: prometheus
                  image: prom/prometheus:latest
                  ports:
                  - containerPort: 9090
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus
            namespace: monitoring
          spec:
            type: NodePort
            ports:
            - port: 9090
              nodePort: 30090
            selector:
              app: prometheus
          EOF
          
          # Deploy Grafana
          kubectl apply -f - << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: monitoring
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                containers:
                - name: grafana
                  image: grafana/grafana:latest
                  ports:
                  - containerPort: 3000
                  env:
                  - name: GF_SECURITY_ADMIN_PASSWORD
                    value: "admin123"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana
            namespace: monitoring
          spec:
            type: NodePort
            ports:
            - port: 3000
              nodePort: 30030
            selector:
              app: grafana
          EOF
          
          # Wait for deployments
          kubectl rollout status deployment/ecom-core-api -n ecommerce --timeout=120s
          kubectl rollout status deployment/ecom-users-api -n ecommerce --timeout=120s
          kubectl rollout status deployment/prometheus -n monitoring --timeout=120s
          kubectl rollout status deployment/grafana -n monitoring --timeout=120s

      - name: Deploy production services
        run: |
          echo "ðŸ“¦ Deploying production services..."
          docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          sleep 20
          
          # Health checks
          curl -f http://localhost:5301/health || echo "Core API not ready"
          curl -f http://localhost:5302/health || echo "Users API not ready"
          curl -f http://localhost:9090 || echo "Prometheus not ready"
          curl -f http://localhost:3000 || echo "Grafana not ready"

      - name: Display deployment summary
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          IP=$(minikube ip)
          echo "ðŸŒ Services:"
          echo "  - Core API: http://localhost:5301"
          echo "  - Users API: http://localhost:5302"
          echo "  - Prometheus: http://localhost:9090 | http://$IP:30090"
          echo "  - Grafana: http://localhost:3000 | http://$IP:30030 (admin/admin123)"
          
          echo ""
          echo "ðŸ“Š Kubernetes Status:"
          kubectl get svc -n ecommerce
          kubectl get svc -n monitoring
